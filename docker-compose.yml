services:
  snacka-server:
    # Use pre-built image from GitHub Container Registry
    # To build locally instead, comment out 'image' and uncomment 'build'
    image: ghcr.io/mattias800/snacka:latest
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    container_name: snacka-server
    ports:
      - "5117:8080"
    environment:
      # Database - set to false to use PostgreSQL
      - UseSqlite=${USE_SQLITE:-true}
      # PostgreSQL connection (used when UseSqlite=false)
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=snacka;Username=snacka;Password=${POSTGRES_PASSWORD:-snacka}
      # JWT Configuration - CHANGE THIS IN PRODUCTION!
      - Jwt__SecretKey=${JWT_SECRET_KEY:-ChangeThisToASecureSecretKeyAtLeast32CharactersLong!}
      - Jwt__Issuer=Snacka
      - Jwt__Audience=Snacka
      - Jwt__AccessTokenExpirationMinutes=60
      - Jwt__RefreshTokenExpirationDays=7
      # Server Info
      - ServerInfo__Name=${SERVER_NAME:-Snacka Server}
      - ServerInfo__Description=${SERVER_DESCRIPTION:-A self-hosted Discord alternative}
      - ServerInfo__AllowRegistration=${ALLOW_REGISTRATION:-true}
      # Tenor GIF API (optional - enables GIF picker)
      - Tenor__ApiKey=${TENOR_API_KEY:-}
      - Tenor__ClientKey=snacka
      # CORS - Add your client origins here for production
      - AllowedOrigins__0=${ALLOWED_ORIGIN:-http://localhost:5117}
      # Logging
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft.AspNetCore=Warning
    volumes:
      # Persist SQLite database
      - snacka-data:/app/data
      # Persist uploaded files (attachments, avatars)
      - snacka-uploads:/app/uploads
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # PostgreSQL database (optional - enable with: docker compose --profile postgres up)
  postgres:
    image: postgres:16-alpine
    container_name: snacka-postgres
    environment:
      - POSTGRES_USER=snacka
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-snacka}
      - POSTGRES_DB=snacka
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U snacka -d snacka"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    profiles:
      - postgres

volumes:
  snacka-data:
    driver: local
  snacka-uploads:
    driver: local
  postgres-data:
    driver: local
